var spreadsheet_count=0,readOnly,contextMenu;!function(a,b){"use strict";"object"==typeof module?module.exports=b:"function"==typeof define&&define.amd?define(b):a.MediumEditorSpreadsheet=b}(this,function(){"use strict";function a(a,b){var c;a=a||{};for(c in b)b.hasOwnProperty(c)&&!a.hasOwnProperty(c)&&(a[c]=b[c]);return a}function b(a){return a.getSelection?a.getSelection().toString():a.selection&&"Control"!==a.selection.type?a.selection.createRange().text:""}function c(){for(var a=document.getElementsByClassName("medium-text-handsontable"),b=0;b<a.length;b++)if(""!==a[b].id){var c=a[b].id,d=(a[b].className,a[b].dataset.height),e=a[b].dataset.width,f=JSON.parse(a[b].dataset.data),g=document.createElement("div");g.id=c,g.contentEditable=!1,a[b].parentNode.insertBefore(g,a[b].nextSibling),a[b].parentNode.removeChild(a[b]);for(var i=new Array(d),j=0;j<d;j++){i[j]=new Array(e);for(var k=0;k<e;k++)i[j][k]=f[j][k]}h(g,i,contextMenu,readOnly)}}function d(a,b,c,d){return this.init(a,b,c,d)}function e(a){return this.init(a)}function f(a){return this.init(a)}function g(a,b){var c=a.getData();b.dataset.height=c.length,b.dataset.width=c[0].length,b.dataset.data=JSON.stringify(c)}function h(a,b,c,d){var e;e=!!c&&["row_above","row_below","---------","col_left","col_right","---------","remove_row","remove_col","---------","undo","redo","make_read_only","---------","alignment",{key:"add_checkmark",name:"Insert checkmark",callback:function(a,b){for(var c=b.start.col;c<=b.end.col;c++)for(var d=b.start.row;d<=b.end.row;d++)this.setDataAtCell(d,c,'<input type="checkbox">')}}];var f=new Handsontable(a,{data:b,className:"medium-text-handsontable",rowHeaders:!0,colHeaders:!0,contextMenu:e,autoWrapCol:!0,autoWrapRow:!0,renderer:"html",placeholder:" ",autoColumnSize:!0,readOnly:d,afterChange:function(b,c){"loadData"!==c&&g(f,a)}});a.contentEditable=!1,g(f,a),a==a.parentNode.lastElementChild&&a.parentNode.insertBefore(document.createElement("br"),a.nextSibling)}function i(b){this.options=a(b,{columns:10,rows:10,readOnly:!1,contextMenu:!0}),this.parent=!0,this.hasForm=!0,this.isFormVisible=!1,this.createButton(),c()}d.prototype={init:function(a,b,c,d){return this._root=a,this._callback=b,this.rows=c,this.columns=d,this._render()},setCurrentCell:function(a){this._currentCell=a},markCells:function(){[].forEach.call(this._cellsElements,function(a){var b={column:parseInt(a.dataset.column,10),row:parseInt(a.dataset.row,10)};!0===(this._currentCell&&b.row<=this._currentCell.row&&b.column<=this._currentCell.column)?a.classList.add("active"):a.classList.remove("active")}.bind(this))},_generateCells:function(){this._cells=[];for(var a=0;a<this.rows*this.columns;a++){var b=a%this.columns,c=Math.floor(a/this.rows);this._cells.push({column:b,row:c,active:!1})}},_html:function(){var a='<div class="medium-editor-table-builder-grid clearfix">';return a+=this._cellsHTML(),a+="</div>"},_cellsHTML:function(){var a="";return this._generateCells(),this._cells.map(function(b){a+='<a href="#" class="medium-editor-table-builder-cell'+(!0===b.active?" active":"")+'" data-row="'+b.row+'" data-column="'+b.column+'">',a+="</a>"}),a},_render:function(){this._root.innerHTML=this._html(),this._cellsElements=this._root.querySelectorAll("a"),this._bindEvents()},_bindEvents:function(){[].forEach.call(this._cellsElements,function(a){this._onMouseEnter(a),this._onClick(a)}.bind(this))},_onMouseEnter:function(a){var b,c=this;a.addEventListener("mouseenter",function(){clearTimeout(b);var a=this.dataset;b=setTimeout(function(){c._currentCell={column:parseInt(a.column,10),row:parseInt(a.row,10)},c.markCells()},50)})},_onClick:function(a){var b=this;a.addEventListener("click",function(a){a.preventDefault(),b._callback(this.dataset.row,this.dataset.column)})}},e.prototype={init:function(a){this.options=a,this._doc=a.ownerDocument||document,this._root=this._doc.createElement("div"),this._root.className="medium-editor-table-builder",this.grid=new d(this._root,this.options.onClick,this.options.rows,this.options.columns)},getElement:function(){return this._root},hide:function(){this._root.style.display="",this.grid.setCurrentCell({column:-1,row:-1}),this.grid.markCells()},show:function(a){this._root.style.display="block",this._root.style.left=a+"px"}};f.prototype={init:function(a){this._editor=a,this._doc=this._editor.options.ownerDocument},insert:function(a,b,c,d,e){spreadsheet_count++;var f=this._html(a,b,c);this._editor.pasteHTML(f,{cleanAttrs:[],cleanTags:[]}),setTimeout(function(){for(var f=document.getElementById("spreadsheet"+c),g=new Array(parseInt(a)+1),i=0;i<g.length;i++)g[i]=Array(parseInt(b)+1).fill("");h(f,g,e,d)})},_html:function(a,c,d){var e="";return e+=b(this._doc),e+=' <div id="spreadsheet'+d+'"> </div> '}};return function(a,b,c,d,e,f,g){Handsontable.renderers.TextRenderer.apply(this,arguments),""&&(b.html='<input type="checkbox">'),b.style.backgroundColor="yellow"},i.prototype={createButton:function(){this._createButtonElement(),this._bindButtonClick()},isDisplayed:function(){return this.isFormVisible},getForm:function(){return this.builder||(this.builder=new e({onClick:function(a,b){readOnly=this.options.readOnly,contextMenu=this.options.contextMenu,this.table.insert(a,b,spreadsheet_count,readOnly,contextMenu),this.hideForm()}.bind(this),ownerDocument:this.document,rows:this.options.rows,columns:this.options.columns}),this.table=new f(this.base)),this.builder.getElement()},getButton:function(){return"fontawesome"===this.base.options.buttonLabels&&(this.button.innerHTML='<i class="fa fa-table"></i>'),this.button},onHide:function(){this.hideForm()},hideForm:function(){this.isFormVisible=!1,this.builder.hide(),this.button.classList.remove("medium-editor-button-active")},show:function(){this.isFormVisible=!0,this.builder.show(this.button.offsetLeft),this.button.classList.add("medium-editor-button-active");for(var a=document.getElementsByClassName("medium-editor-table-builder-grid"),b=0;b<a.length;b++)a[b].style.height=16*this.options.rows+2+"px",a[b].style.width=16*this.options.columns+2+"px"},_createButtonElement:function(){this.button=document.createElement("button"),this.button.className="medium-editor-action",this.button.innerHTML="tbl"},_bindButtonClick:function(){this.button.addEventListener("click",function(a){a.preventDefault(),this[!0===this.isFormVisible?"hideForm":"show"]()}.bind(this))}},i}());